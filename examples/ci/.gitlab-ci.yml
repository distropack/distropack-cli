variables:
  DISTROPACK_PACKAGE_ID: "${DISTROPACK_PACKAGE_ID}"
  DISTROPACK_API_TOKEN: "${DISTROPACK_API_TOKEN}"
  DISTROPACK_API_URL: "${DISTROPACK_API_URL}"

stages:
  - build
  - package

before_script:
  - |
    # Install DistroPack CLI
    # Option 1: Download from releases
    # curl -L https://github.com/distropack/distropack-cli/releases/latest/download/distropack-cli-x86_64-unknown-linux-gnu -o distropack-cli
    # chmod +x distropack-cli
    # export PATH=$PWD:$PATH
    
    # Option 2: Build from source
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source $HOME/.cargo/env
    cargo install --path distropack-cli --locked

build-package:
  stage: build
  script:
    - |
      # Determine version from CI_COMMIT_TAG or CI_COMMIT_REF_SLUG
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION=${CI_COMMIT_TAG#v}
      else
        VERSION=${CI_COMMIT_REF_SLUG}
      fi
      
      echo "Building version: $VERSION"
      
      # Upload files
      distropack-cli upload --package-id $DISTROPACK_PACKAGE_ID --ref-id source-tarball --file dist/myapp-$VERSION.tar.gz
      distropack-cli upload --package-id $DISTROPACK_PACKAGE_ID --ref-id changelog --file CHANGELOG.md
      
      # Trigger builds for all enabled targets
      distropack-cli build --package-id $DISTROPACK_PACKAGE_ID --version $VERSION
  only:
    - tags
    - main
    - master


